Layer Zero: 블록체인 간의 상호 운용성 문제가 명확하게 해결해버렸다. 
-> Lock and mint를 Burn and mint로 전환시키다.

<img width="995" height="536" alt="image" src="https://github.com/user-attachments/assets/baf49faf-8a00-4fd9-8a6c-fe37a6665a8e" />


레이어제로의 구조

레이어제로 V2의 아키텍처에는 세 가지 주요 구성 요소가 있다:

1. 엔드포인트 컨트랙트(Endpoint Contract): 이는 크로스체인 메시지의 진입점 역할을 한다.

2. 분산화된 검증자 네트워크(DVN): 블록체인 간 크로스체인 메시지 전달의 무결성과 보안을 관리한다.

3. 실행자(Executor): 메시지의 정보에 따라 다른 블록체인으로 메시지를 실행한다.

레이어제로 메시지의 트랜잭션 흐름에는 옴니체인 애플리케이션(OApp)을 통해 소스 블록체인에서 대상 블록체인으로의 크로스체인 통신을 가능하게 하는 여러 단계로 진행된다.

--------------------------------------------------------------------

트랜잭션 흐름

메시지 개시

사용자는 OApp에서 _lzSend 메서드를 호출하여 크로스체인 통신을 시작하고, 이는 LayerZero 엔드포인트에서 send 메서드를 트리거한다. 여기 메시지에서는 파라미터와 수수료 관리를 위한 환불 주소 등의 정보가 포함된다.
수수료 계산 및 제출: 트랜잭션 수수료는 lzToken으로 지불해야 하며, lzToken을 사용할 수 없는 경우(주소가 0x0으로 설정된 경우) 트랜잭션은 되돌려진다. 사용자 또는 OApp은 예상 비용을 충당하기 위해 체 의 네의이티브 토큰 또는 lzToen 토큰으로 정확한 금액의 수수료가 제공되도록 해야 한다.
메시지 생성 및 전송: 수수료를 처리하고 모든 매개변수가 올바르게 설정되었는지 확인한 후, 엔드포인트의 온체인 메시지 라이브러리(MessageLib)는 메시지 패킷을 생성한다. 이 패킷은 OApp 소유자가 지정한 구성에 따라 구성되며, 대상 블록체인, 수신자 주소, 실제 메시지 내용과 같은 데이터를 포함하는 이벤트로 전송된다.

메시지 보안 및 확인

이벤트 발생: 이 단계에서는 DVN 인프라가 포함된 보안 스택이 전송된 이벤트를 수신 대기하다가 발생된 이벤트를 확인한다.
확인 및 검증: 이 단계에서 시스템은 트랜잭션의 최종성을 보장하기 위해 미리 정해진 횟수의 블록 확인을 기다린다. 그 후 메시지의 무결성을 검증한다.
페이로드 검증: 이 단계에서는 목적지 체인의 메시지 라이브러리에서 '페이로드 해시'를 검증한다. 수신된 메시지가 전송된 패킷과 일치하는지 확인한다.

메시지 실행: 메시지 실행

메시지 수신: 호출자(일반적으로 실행자 또는 지정된 스마트 컨트랙트)가 대상 엔드포인트에서 lzReceive 함수를 호출한다.
메시지 실행: 이제 목적지 엔드포인트는 목적지의 OApp 컨트랙트에 정의된 _lzReceive 함수를 트리거하여 메시지가 지정한 실제 로직이 실행된다.
실행 컨텍스트의 유효성 검사: 수신 엔드포인트는 메시지를 실행하고 실행자가 제공한 신뢰할 수 없는 추가 데이터를 검증하여 발신자와 추가 컨텍스트가 보안 요구 사항을 충족하는지 확인할 수 있다.
확인 및 완료: 작업은 메시지의 성공적인 전달과 실행을 확인하는 PacketDelivered 이벤트를 발생시키는 것으로 마무리된다.

--------------------------------------------------------------------------

https://github.com/LayerZero-Labs/LayerZero-v2/tree/main/packages/layerzero-v2/

레이어제로의 코드를 보면 Aptos EVM Initia Iota Solana Sui ton 폴더가 있는데 

그 중 EVM 폴더에는 messagelib oapp protocol이 있음 이중 oapp 에 대해 알아보자

<img width="285" height="213" alt="image" src="https://github.com/user-attachments/assets/14e5fb24-7222-4cc5-b5af-c667a2dd6ac1" /> 

OApp
├── OAppCore (기본 구성)
├── OAppSender (송신 기능)
└── OAppReceiver (수신 기능)

OFT
├── OFTCore (토큰 로직)
├── OFT (네이티브 토큰)
└── OFTAdapter (기존 토큰 적응)

PreCrime
├── PreCrime (보안 검증)
└── OAppPreCrimeSimulator (시뮬레이션)

1. 크로스체인 메시징: OApp 기반 임의 데이터 전송
2. 토큰 브릿징: OFT/OFTAdapter로 토큰 크로스체인 이동
3. 읽기 전용 쿼리: OAppRead로 원격 상태 조회
4. 보안 검증: PreCrime으로 의심 거래 탐지

--------------------------------------------



1. OApp 핵심 계층
<img width="691" height="600" alt="image" src="https://github.com/user-attachments/assets/64d1c2e8-50cb-42f4-92f8-0d0dcd973922" />



OAppCore.sol

상속 구조: Ownable 상속, IOAppCore 인터페이스 구현

주요 상태 변수:
ILayerZeroEndpointV2 public immutable endpoint: LayerZero 엔드포인트 주소

mapping(uint32 eid => bytes32 peer) public peers: 엔드포인트 ID별 신뢰할 수 있는 피어 매핑

핵심 함수:
setPeer(uint32 _eid, bytes32 _peer): 특정 엔드포인트의 피어 설정 (onlyOwner)

_getPeerOrRevert(uint32 _eid): 피어 조회, 설정되지 않은 경우 revert

setDelegate(address _delegate): 델리게이트 주소 설정

보안 고려사항: onlyOwner 제한자로 구성 변경 제한, 불변 엔드포인트로 조작 방지

---------
OApp.sol

상속 구조: OAppSender와 OAppReceiver 다중 상속

기능: 송수신 기능을 결합한 완전한 OApp 구현의 기반

oAppVersion(): 송신자/수신자 버전 정보 반환

----------
OAppReceiver.sol

상속 구조: OAppCore 상속, IOAppReceiver 구현

핵심 함수:
lzReceive(): 메시지 수신 진입점, 엔드포인트와 피어 검증 후 내부 _lzReceive 호출

isComposeMsgSender(): 컴포즈 메시지 발송자 검증

allowInitializePath(): 경로 초기화 허용 여부 확인

nextNonce(): 기본적으로 0 반환 (순서 보장 비활성화)

보안 특징: OnlyEndpoint, OnlyPeer 에러로 무단 호출 방지

-----------------------------------------------
OAppSender.sol

상속 구조: OAppCore 상속

핵심 함수:
_lzSend(): 내부 메시지 전송 함수, 네이티브/LZ 토큰 수수료 처리

_quote(): 수수료 견적 제공

_payNative(), _payLzToken(): 수수료 지불 처리

보안 특징: 수수료 검증, 초과 수수료 환불로 DoS 방지

---------------
2. OFT (Omnichain Fungible Token) 계층
<img width="483" height="369" alt="image" src="https://github.com/user-attachments/assets/f7e46e31-7b73-454e-b526-70ba69b70c54" />


OFTCore.sol

상속 구조: IOFT, OApp, OAppPreCrimeSimulator, OAppOptionsType3 상속

주요 상태 변수:

uint256 public immutable decimalConversionRate: 로컬/공유 소수점 간 변환율

address public msgInspector: 선택적 메시지 검사 컨트랙트

핵심 함수:

send(): 토큰 크로스체인 전송 실행

quoteSend(): 전송 수수료 견적

_debit(), _credit(): 토큰 차감/적립 추상 함수

_toLD(), _toSD(): 로컬/공유 소수점 변환

메시지 타입:

SEND = 1: 단순 전송

SEND_AND_CALL = 2: 전송 + 컴포즈 호출

---------------
OFT.sol

상속 구조: OFTCore, ERC20 상속

토큰 모델: 네이티브 토큰 (burn/mint 방식)

_debit(): 토큰 소각

_credit(): 토큰 발행

approvalRequired(): false 반환 (자체 토큰이므로 승인 불필요)

------------
OFTAdapter.sol

상속 구조: OFTCore 상속

토큰 모델: 기존 ERC20 토큰 적응 (lock/unlock 방식)

_debit(): 토큰 잠금 (컨트랙트로 전송)

_credit(): 토큰 해제 (컨트랙트에서 전송)

approvalRequired(): true 반환 (기존 토큰 승인 필요)

--------------------
3. PreCrime 보안 계층
<img width="314" height="308" alt="image" src="https://github.com/user-attachments/assets/decc0b9f-c6b5-4ddc-8050-8fe67eae6ca1" />


PreCrime.sol


상속 구조: Ownable, IPreCrime 구현

핵심 상태 변수:

uint64 public maxBatchSize: 최대 배치 크기

PreCrimePeer[] internal preCrimePeers: PreCrime 피어 목록

핵심 함수:

simulate(): 패킷 시뮬레이션 실행

preCrime(): 실제 PreCrime 검증 수행

getConfig(): PreCrime 설정 반환

보안 메커니즘: 패킷 순서 검증, 크기 제한, 시뮬레이션 결과 비교

----------------------------------------
OAppPreCrimeSimulator.sol

시뮬레이션 기능:

lzReceiveAndRevert(): 패킷 시뮬레이션 후 결과와 함께 revert

lzReceiveSimulate(): 개별 패킷 시뮬레이션








